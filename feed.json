{
    "version": "https://jsonfeed.org/version/1",
    "title": "ななこの思い",
    "subtitle": "學習記錄&思考",
    "icon": "http://nanakoww.com/images/favicon.ico",
    "description": "",
    "home_page_url": "http://nanakoww.com",
    "items": [
        {
            "id": "http://nanakoww.com/frontend/%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E2%80%94%E2%80%94%E5%AD%97%E4%BD%93%E7%AF%87/",
            "url": "http://nanakoww.com/frontend/%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E2%80%94%E2%80%94%E5%AD%97%E4%BD%93%E7%AF%87/",
            "title": "如何提高前端性能——字体篇",
            "date_published": "2023-02-02T07:49:55.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>有时候前端开发需要使用到一些特殊字体，但宿主机上一般都没有安装相应的字体，所以需要将字体文件与前端代码一起打包以及用 CSS 定义使用。本文主要是想回答一个问题：在性能方面，我们可以怎么去优化前端需要加载的字体？</p>\n<p>一般优化的思路主要是两方面：</p>\n<ol>\n<li>缩小字体文件</li>\n<li>优化字体加载的方式</li>\n</ol>\n<h1 id=\"缩小字体文件\"><a class=\"anchor\" href=\"#缩小字体文件\">#</a> 缩小字体文件</h1>\n<p>字体文件一般都比较大，动不动就几兆、十几兆的，所以我们优化的第一步是想办法缩减字体文件的大小。</p>\n<h2 id=\"使用特定的字体格式woffwoff2\"><a class=\"anchor\" href=\"#使用特定的字体格式woffwoff2\">#</a> 使用特定的字体格式 ——WOFF/WOFF2</h2>\n<p>常见的字体格式有 TTF（TrueType Font）、OTF（OpenType Font）、EOT（Embedded Open Type）、WOFF（Web Open Font Format）和 WOFF2。</p>\n<blockquote>\n<p>更详细的介绍字体的文章可以看：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODE3OTIwMw==\">Web 字体简介: TTF, OTF, WOFF, EOT &amp; SVG</span></p>\n</blockquote>\n<p>简单来说，TTF 和 OTF 都是没有压缩，所以这两个格式的字体文件会更大；EOT 字体格式只有 IE 浏览器支持；SVG 对文本的支持不够好… 等等，因此<strong>使用 WOFF 可以说是前端开发的最佳选择</strong>了。（还有专家建议只用 WOFF2 字体，原文如下）</p>\n<blockquote>\n<p>In fact, we think it is also time to proclaim: Use only WOFF2 and forget about everything else.<br />\nThis will simplify your CSS and workflow massively and also prevents any accidental double or incorrect font downloads. WOFF2 is now supported everywhere. So, unless you need to support really ancient browsers, just use WOFF2. If you can't, consider not serving any web fonts to those older browsers at all. This will not be a problem if you have a robust fallback strategy in place. Visitors on older browsers will simply see your fallback fonts.</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hbG1hbmFjLmh0dHBhcmNoaXZlLm9yZy9lbi8yMDIyL2ZvbnRzI3BlcmZvcm1hbmNl\">Bram Stein, from the 2022 Web Almanac</span></p>\n</blockquote>\n<p>WOFF 的优点主要有两个：</p>\n<ol>\n<li>字体经过压缩，文件大小一般比 TTF 小 40%；</li>\n<li>主流的浏览器新版本都支持此格式；</li>\n</ol>\n<blockquote>\n<p>WOFF2 是 WOFF 的升级版，压缩率在此基础上提高了 30%。</p>\n</blockquote>\n<h2 id=\"按需压缩字体\"><a class=\"anchor\" href=\"#按需压缩字体\">#</a> 按需压缩字体</h2>\n<p>有时候前端页面中需要使用特殊字体的文本是固定的，那么就可以利用 <code>font-spider</code>  (同类开源库还有 <code>fontmin</code>  等) 去将文本所对应的字体子集提取出来，生成一个新的子集包代替原本的全量字体包，这样即可大大减小字体文件，提高性能。</p>\n<h3 id=\"使用方式\"><a class=\"anchor\" href=\"#使用方式\">#</a> 使用方式</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2F1aS9mb250LXNwaWRlcg==\">官方指南</span></p>\n<p>font-spider 可以自动分析出页面中使用过的字体并进行按需压缩，也就是说，如果页面中的文本有改动就需要重新压缩。这种压缩方式比较<strong>适合页面的文字一般不会改动的场景</strong>。</p>\n<p>下面是我对某个字体文件的提取对比，在这个情境中我的网站只有数字部分用到了这个字体，所以没必要把整个字体文件都打包进去，所以我使用了 font-spider 把字体文件中的数字部分提取出来了。</p>\n<p><img data-src=\"https://res.craft.do/user/full/a1388a82-3d1e-59f9-6dfb-26cfc7539142/doc/D3BB5B46-6795-4B27-AEA3-23501E679264/75ADDFB3-F7FD-4023-A46B-8482F3D09D0F_2/qJNxhVa0zNuxR5CzVOcornxtwMZNxlsD7MjHhnTer5kz/Image.png\" alt=\"Image.png\" /></p>\n<p><img data-src=\"https://res.craft.do/user/full/a1388a82-3d1e-59f9-6dfb-26cfc7539142/doc/D3BB5B46-6795-4B27-AEA3-23501E679264/B571B409-836A-4657-B8D8-3F543D468EEE_2/3ArqPjCHzynPj9wVIAbf0tjVTgHJktY38vA6qHgvIB0z/Image.png\" alt=\"Image.png\" /></p>\n<p>字体压缩前后的效果对比：</p>\n<p><img data-src=\"https://res.craft.do/user/full/a1388a82-3d1e-59f9-6dfb-26cfc7539142/doc/D3BB5B46-6795-4B27-AEA3-23501E679264/EFA38A2E-D819-4D70-8C97-188B75C8ABDA_2/XWoWRP2nacKL4syb323JnkFjsKItMvWTkRib3J1MU0sz/Image.png\" alt=\"Image.png\" /></p>\n<p><img data-src=\"https://res.craft.do/user/full/a1388a82-3d1e-59f9-6dfb-26cfc7539142/doc/D3BB5B46-6795-4B27-AEA3-23501E679264/CDF8F253-0D38-44B6-9431-932EDC184306_2/eFFM26luiVLH2zDfVcOn08skHw0PrkjELCraE3VVckoz/Image.png\" alt=\"Image.png\" /></p>\n<h1 id=\"优化字体加载的方式\"><a class=\"anchor\" href=\"#优化字体加载的方式\">#</a> 优化字体加载的方式</h1>\n<p>下图展示了浏览器绘制页面的过程：</p>\n<p><img data-src=\"https://f004.backblazeb2.com/file/Nanako-blog/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_584a4530-0d01-4768-bada-77c59d0492ef.png\" alt=\"Image.png\" /></p>\n<p>从图片我们可以看出，浏览器从请求 html 文档到呈现文本，中间还有好几个步骤。因此字体的请求会比其他关键资源请求之后延迟很长时间，并且，在获取到字体资源前，浏览器处理文本的方式也各不相同。</p>\n<p>在加载网页上的字体时，浏览器一般会有两种选择：</p>\n<ol>\n<li>推迟渲染字体的时间直到字体资源下载完成（导致 FOIT）。</li>\n<li>在下载好字体资源前用备用字体展示该内容（导致 FOUT）。</li>\n</ol>\n<h2 id=\"减少浏览器请求的次数\"><a class=\"anchor\" href=\"#减少浏览器请求的次数\">#</a> 减少浏览器请求的次数</h2>\n<p>虽然在使用非默认系统字体时，用户一般不会在本地安装相应的文件，但是开发者仍然需要考虑到这种情况。在定义  <code>font-face</code>  时，可以使用  <code>local()</code>  先请求本地字体，示例代码如下：</p>\n<figure class=\"highlight css\"><figcaption data-lang=\"CSS\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token atrule\"><span class=\"token rule\">@font-face</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token property\">font-family</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Awesome Font'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token property\">font-style</span><span class=\"token punctuation\">:</span> normal<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token property\">font-weight</span><span class=\"token punctuation\">:</span> 400<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token property\">src</span><span class=\"token punctuation\">:</span> <span class=\"token function\">local</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Awesome Font'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token string url\">'/fonts/awesome.woff2'</span><span class=\"token punctuation\">)</span></span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'woff2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token string url\">'/fonts/awesome.woff'</span><span class=\"token punctuation\">)</span></span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'woff'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token string url\">'/fonts/awesome.ttf'</span><span class=\"token punctuation\">)</span></span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'truetype'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token string url\">'/fonts/awesome.eot'</span><span class=\"token punctuation\">)</span></span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'embedded-opentype'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>对于这段代码，浏览器会按照下述顺序去请求资源：</p>\n<ol>\n<li>浏览器渲染页面的 DOM 树，判断出需要加载哪个字体。</li>\n<li>循环判断每个需要的字体是否可以本地使用。</li>\n<li>如果本地没有该字体，就按照代码顺序去请求  <code>url()</code>  中定义的字体资源。\n<ol>\n<li>如果有定义  <code>format</code>  ，那么浏览器在下载字体资源前会先检查自己支不支持该格式，如果不支持，则继续请求下一行代码定义的字体资源。</li>\n<li>如果没有定义  <code>format</code>  ，则直接下载该资源。</li>\n</ol>\n</li>\n</ol>\n<h2 id=\"使用-font-display\"><a class=\"anchor\" href=\"#使用-font-display\">#</a> 使用 font-display</h2>\n<p>虽然不同的浏览器会对字体加载有不同的处理方式，但是开发者可以用  <code>font-display</code>  去控制这个行为。</p>\n<blockquote>\n<p><code>font-display</code>  在 CSS 层面上提供了此类问题的解决方法，它提供了五个属性：</p>\n<ul>\n<li>auto：使用浏览器默认的行为；</li>\n<li>block：浏览器首先使用隐形文字替代页面上的文字，并等待字体加载完成再显示；</li>\n<li>swap：如果设定的字体还未可用，浏览器将首先使用备用字体显示，当设定的字体加载完成后替换备用字体；</li>\n<li>fallback：与  <code>swap</code>  属性值行为上大致相同，但浏览器会给设定的字体设定加载的时间限制，一旦加载所需的时长大于这个限制，设定的字体将不会替换备用字体进行显示。 Webkit 和 Firefox 中设定此时间为 3s；</li>\n<li>optional：使用此属性值时，如果设定的字体没有在限制时间内加载完成，当前页面将会一直使用备用字体，并且设定字体继续在后台进行加载，以便下一次浏览时可以直接使用设定的字体。</li>\n</ul>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzNjY1ODc1MDI1OTI4\">NimitzDEV,《页面字体闪一下？这两个标准能帮到你》</span></p>\n</blockquote>\n<p>采用什么样的加载策略取决于字体的重要性、个人审美以及性能考虑等等，因此在此不做推荐，以下是几种主要策略：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>性能优先</th>\n<th>速度优先</th>\n<th>网络字体优先</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>推荐值</td>\n<td>optional</td>\n<td>swap</td>\n<td>block</td>\n</tr>\n<tr>\n<td>优点</td>\n<td>非常高效，文本呈现时间短。</td>\n<td>可以保证在使用网络字体的前提下尽早完成字体的渲染。</td>\n<td>可以最大程度确保优先使用网络字体；尽管也会出现布局偏移，但是显示效果比 swap 的效果更平滑。</td>\n</tr>\n<tr>\n<td>缺点</td>\n<td>如果浏览器在限制时间内没有下载完字体，则不会加载网络字体。</td>\n<td>如果字体请求过久，会导致页面出现 FOUT 闪烁。</td>\n<td>这个策略推迟了文本的显示时间，导致 FOIT 闪烁。</td>\n</tr>\n</tbody>\n</table>\n<p>综上所述，开发者可以根据实际情况选择不同的策略，例如 <code>font-display: swap</code>  用于品牌和其他视觉上与众不同的页面元素； <code>font-display: optional</code>  用于正文中使用的字体。</p>\n<h2 id=\"自定义加载方式\"><a class=\"anchor\" href=\"#自定义加载方式\">#</a> 自定义加载方式</h2>\n<p>如果开发者希望自定义字体加载的方式，并且愿意承担额外的 js 开销，那么还有以下选择：</p>\n<ol>\n<li>\n<p>利用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudzMub3JnL1RSL2Nzcy1mb250LWxvYWRpbmcv\">字体加载 API</span> 去定义或者操作字体的加载行为（但是在旧浏览器中不可用）</p>\n<blockquote>\n<p>例如，如果您确定需要特定的字体变体，您可以定义它并告诉浏览器立即启动字体资源的获取：</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">var</span> font <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FontFace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Awesome Font\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"url(/fonts/awesome.woff2)\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token literal-property property\">style</span><span class=\"token operator\">:</span> <span class=\"token string\">'normal'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">unicodeRange</span><span class=\"token operator\">:</span> <span class=\"token string\">'U+000-5FF'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">weight</span><span class=\"token operator\">:</span> <span class=\"token string\">'400'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// don't wait for the render tree, initiate an immediate fetch!</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>font<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token comment\">// apply the font (which may re-render text and cause a page reflow)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token comment\">// after the font has finished downloading</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> document<span class=\"token punctuation\">.</span>fonts<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>font<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>fontFamily <span class=\"token operator\">=</span> <span class=\"token string\">\"Awesome Font, serif\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token comment\">// OR... by default the content is hidden,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token comment\">// and it's rendered after the font is available</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token keyword\">var</span> content <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> content<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>visibility <span class=\"token operator\">=</span> <span class=\"token string\">\"visible\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token comment\">// OR... apply your own render strategy here...</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>此外，因为您可以检查字体状态（通过<a href=\"https://www.w3.org/TR/css-font-loading/#font-face-set-check\"> <code>check()</code> </a> ）方法并跟踪其下载进度。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuZGV2L29wdGltaXplLXdlYmZvbnQtbG9hZGluZy8=\">Ilya Grigorik, 《优化 WebFont 加载和呈现》</span></p>\n</blockquote>\n</li>\n<li>\n<p>使用 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3R5cGVraXQvd2ViZm9udGxvYWRlcg==\">Web Font Loader</span><br />\n 只要在脚本中添加下列代码，即可使用它所提供的加载功能：</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  WebFont<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">google</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token literal-property property\">families</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Droid Sans'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Droid Serif'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>它同时支持同步加载和异步加载，自由度较高。</p>\n</li>\n<li>\n<p>其他方式<br />\n由于自定义的可能性实在是太多了，业内也有好几个开源库，因此在这里不穷举所有的实现方式。有兴趣的朋友可以阅读<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuemFjaGxlYXQuY29tL3dlYi9jb21wcmVoZW5zaXZlLXdlYmZvbnRzLyNmb3V0LWNsYXNz\"> A COMPREHENSIVE GUIDE TO FONT LOADING STRATEGIES</span>，<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZmlsYW1lbnRncm91cC5jb20vbGFiL2ZvbnQtZXZlbnRzLmh0bWw=\">How We Load Web Fonts Progressively</span> 以及<span class=\"exturl\" data-url=\"aHR0cHM6Ly8yODI3MTQubWVkaXVtLmNvbS8lRTclQjYlQjIlRTklQTAlODElRTUlOEElQTAlRTglQkMlODklRTUlQUQlOTclRTUlOUUlOEJmb2l0LWZvdXQlRTglODglODclRTYlOTUlODglRTglODMlQkQlRTYlQjglQUMlRTglQTklQTYtY2IwYjAzZGFhZDYw\">網頁加載字型 Web Font FOIT&amp; FOUT 與效能測試</span>等文章。</p>\n</li>\n</ol>\n<h2 id=\"预加载字体资源\"><a class=\"anchor\" href=\"#预加载字体资源\">#</a> 预加载字体资源</h2>\n<p>上文提到了如何控制浏览器处理暂不可用的字体，除此之外，开发者还可以通过  <code>preconnect</code>  和  <code>preload</code>  加快字体资源加载的速度。</p>\n<h3 id=\"preconnect\"><a class=\"anchor\" href=\"#preconnect\">#</a> preconnect</h3>\n<p>如果开发者选择在第三方站点上托管字体，那么可以用  <code>preconnect</code>  预先与第三方来源建立连接，示例：</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preconnect<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://fonts.com<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preconnect<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://fonts.com<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crossorigin</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h3 id=\"preload\"><a class=\"anchor\" href=\"#preload\">#</a> preload</h3>\n<p>使用  <code>preload</code>  可以让浏览器优先下载字体资源，从而加快网页显示文本的速度，示例：</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token comment\">&lt;!-- ... --></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preload<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/assets/Pacifico-Bold.woff2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">as</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>font<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>font/woff2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crossorigin</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>但是如果使用不当，预加载可能会对未使用的资源发出不必要的请求，从而导致性能损耗。</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>最简单直接的优化方式就是只用系统字体（System Font）或者可变字体（Variable Font）来减少甚至清零所需要请求的网络字体的数量；如果不得不使用网络字体，可以试试上述方式去优化网页性能。这些优化手段可以互相组合去使用，取得 1+1&gt;2 的效果。</p>\n<p>本文只是一个粗略的介绍，对于细节问题没有过多涉及，欢迎在评论区补充更多信息。</p>\n<h1 id=\"参考资料\"><a class=\"anchor\" href=\"#参考资料\">#</a> 参考资料</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82OTg0OTcxOTA1MDY5NDgyMDIx\">前端网页字体优化指南</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuZGV2L2NvZGVsYWItcHJlbG9hZC13ZWItZm9udHMv\">通过预加载 web 字体提高加载速度</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzNjY1ODc1MDI1OTI4\">页面字体闪一下？这两个标准能帮到你</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuZGV2L2Zhc3QvIw==\">快速加载</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly8yODI3MTQubWVkaXVtLmNvbS8lRTclQjYlQjIlRTklQTAlODElRTUlOEElQTAlRTglQkMlODklRTUlQUQlOTclRTUlOUUlOEJmb2l0LWZvdXQlRTglODglODclRTYlOTUlODglRTglODMlQkQlRTYlQjglQUMlRTglQTklQTYtY2IwYjAzZGFhZDYw\">網頁加載字型 Web Font FOIT&amp; FOUT 與效能測試</span></p>\n",
            "tags": [
                "Frontend",
                "Frontend"
            ]
        },
        {
            "id": "http://nanakoww.com/frontend/%E5%85%A8%E7%BD%91%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD%E5%AE%9E%E7%8E%B0%EF%BC%88React+Go%EF%BC%89/",
            "url": "http://nanakoww.com/frontend/%E5%85%A8%E7%BD%91%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD%E5%AE%9E%E7%8E%B0%EF%BC%88React+Go%EF%BC%89/",
            "title": "全网最简单的大文件上传与下载实现（React+Go）",
            "date_published": "2022-09-06T13:03:55.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>前段时间我需要实现大文件上传的需求，在网上查找了很多资料，并且也发现已经有很多优秀的博客讲了大文件上传下载这个功能。</p>\n<p>我的项目是个比较简单的项目，并没有采用特别复杂的实现方式，所以我这篇文章的目的主要是讲如何最简单地实现大文件上传与下载这个功能，不会讲太多原理之类的东西。</p>\n<h1 id=\"大文件上传\"><a class=\"anchor\" href=\"#大文件上传\">#</a> 大文件上传</h1>\n<p>在实际场景中，上传大文件主要会遇到的问题有：</p>\n<ul>\n<li>体积大 / 网络不好时，上传时间会非常久</li>\n<li>前端 / 后端某处设置了最大请求时长 / 最大读写时长等，造成文件上传超时</li>\n<li>Nginx / 后端某处对请求大小进行了限制，造成文件因体积过大而上传失败</li>\n<li>上传失败后，需要重新开始上传</li>\n</ul>\n<h2 id=\"实现思路\"><a class=\"anchor\" href=\"#实现思路\">#</a> 实现思路</h2>\n<p>业界最普遍的方案就是切片上传，简单地说就是<strong>把文件切割成若干个小文件，再将小文件们传输到后端，最后按照顺序把小文件们重新拼成这个大文件</strong>。</p>\n<p>所以具体的实现逻辑如下：</p>\n<ol>\n<li>\n<p>把大文件进行切片，对切片的文件内容进行加密生成一个标识串，用于标识唯一的切片</p>\n</li>\n<li>\n<p>服务端在临时目录里保存各段文件</p>\n</li>\n<li>\n<p>浏览器端所有分片上传完成，发送给服务端一个合并文件的请求</p>\n</li>\n<li>\n<p>服务端根据分片顺序进行文件合并</p>\n</li>\n<li>\n<p>删除分片文件</p>\n</li>\n</ol>\n<blockquote>\n<p>也有其他合并文件的方式，本文不做讨论，详情可以参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODY0OTMxMzU=\">如何做大文件上传</span>。</p>\n</blockquote>\n<h2 id=\"具体实现\"><a class=\"anchor\" href=\"#具体实现\">#</a> 具体实现</h2>\n<h3 id=\"前端部分\"><a class=\"anchor\" href=\"#前端部分\">#</a> 前端部分</h3>\n<p>前端需要做的部分是：</p>\n<ul>\n<li>把大文件进行切片，对切片的文件内容进行加密生成一个标识串</li>\n<li>上传所有切片，最后发送合并文件的请求</li>\n</ul>\n<p>在这里我使用了一个开源库 <code>react-chunk-upload</code> ，它提供了加密文件函数和获取文件的相应切片内容的函数（如图），这就不用我自己写啦（偷懒小技巧）。</p>\n<p>![image-20220902173311715](/Users/nanagan/Library/Application Support/typora-user-images/image-20220902173311715.png)</p>\n<p>那么前端部分完整的代码如下：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>uploadProgress<span class=\"token punctuation\">,</span> setUploadProgress<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>uploadText<span class=\"token punctuation\">,</span> setUploadText<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">CHUNK_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 设置切片大小为 3Mb</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> chunkMD5List <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> chunkNum <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">/</span> <span class=\"token constant\">CHUNK_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> chunkNum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> <span class=\"token constant\">CHUNK_SIZE</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 切片的开始位置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> end <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> start <span class=\"token operator\">+</span> <span class=\"token constant\">CHUNK_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 切片的结束位置</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">const</span> chunkBlob <span class=\"token operator\">=</span> <span class=\"token function\">blobSlice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取相应位置的切片文件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">const</span> chunkFile <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>chunkBlob<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"file\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token literal-property property\">lastModified</span><span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>lastModified<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">const</span> md5 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">hashFile</span><span class=\"token punctuation\">(</span>chunkFile<span class=\"token punctuation\">,</span> <span class=\"token constant\">CHUNK_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 获取切片标识符</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  chunkMD5List<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>md5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">await</span> <span class=\"token function\">beforeUploadCheckApi</span><span class=\"token punctuation\">(</span>md5<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 上传前检查这个切片是否已存在的接口</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token constant\">SUCCESS_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>exist_status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 如果不存在才上传</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">await</span> <span class=\"token function\">uploadChunkCSVApi</span><span class=\"token punctuation\">(</span>chunkFile<span class=\"token punctuation\">,</span> md5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// 上传切片的接口</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token constant\">SUCCESS_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">const</span> progress <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> chunkNum<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计算上传进度，这里为了更好的用户体验，我特意预留了 3% 给最后的合并文件步骤</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token function\">setUploadProgress</span><span class=\"token punctuation\">(</span>progress <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> progress <span class=\"token operator\">-</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">const</span> progress <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> chunkNum<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token function\">setUploadProgress</span><span class=\"token punctuation\">(</span>progress <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> progress <span class=\"token operator\">-</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">setUploadText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"上传失败\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token function\">mergeChunkApi</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>chunkMD5List<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 合并切片的接口</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token constant\">SUCCESS_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">setUploadText</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">上传 </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>file<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> 成功</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">setUploadProgress</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 合并文件需要一些时间，所以合并完再让进度条到 100</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token function\">setUploadText</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">合并保存文件失败</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"后端部分\"><a class=\"anchor\" href=\"#后端部分\">#</a> 后端部分</h3>\n<p>后端需要提供三个接口，分别是：</p>\n<ol>\n<li>判断切片文件是否已经上传过</li>\n<li>上传切片文件</li>\n<li>合并切片文件</li>\n</ol>\n<p>前两个接口的逻辑都很简单，第一个接口是<strong>判断文件目录是否存在</strong>，第二个接口是<strong>把文件放到指定目录</strong>。</p>\n<p>第三个接口的合并逻辑也不难，就是按照顺序读取切片文件然后写入，代码如下:</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 创建一个空文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>filePath <span class=\"token operator\">:=</span> <span class=\"token string\">\".....省略\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>f<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">OpenFile</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> os<span class=\"token punctuation\">.</span>O_CREATE<span class=\"token operator\">|</span>os<span class=\"token punctuation\">.</span>O_WRONLY<span class=\"token operator\">|</span>os<span class=\"token punctuation\">.</span>O_APPEND<span class=\"token punctuation\">,</span> os<span class=\"token punctuation\">.</span>ModePerm<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打开文件失败: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>chunkMD5Array <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token string\">``</span><span class=\"token string\">`</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>前端需要传给后端一个切片名称的有序数组，此处省略具体处理过程</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>`</span><span class=\"token string\">``</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> chunkMD5 <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> chunkMD5Array <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  chunkPath <span class=\"token operator\">:=</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/temp/%v\"</span><span class=\"token punctuation\">,</span> chunkMD5<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  chunk<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>chunkPath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"打开文件的切片 %v 内容失败: %v\"</span><span class=\"token punctuation\">,</span> chunkMD5<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  content<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> ioutil<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAll</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"读取文件的切片 %v 内容失败: %v\"</span><span class=\"token punctuation\">,</span> chunkMD5<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"写入文件的切片 %v 内容失败: %v\"</span><span class=\"token punctuation\">,</span> chunkMD5<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  chunk<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">// 写入完毕，关闭文件</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>f<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">// 合并后删除切片文件</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> chunkMD5 <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> chunkMD5Array <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  chunkPath <span class=\"token operator\">:=</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/temp/%v\"</span><span class=\"token punctuation\">,</span> chunkMD5<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">RemoveAll</span><span class=\"token punctuation\">(</span>chunkPath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"删除切片文件%v失败：%v\"</span><span class=\"token punctuation\">,</span> chunkMD5<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>大文件上传就这么简单地搞定了，并且这个实现方法虽然不是断点续传，但是也会大大提高文件的上传速度。</p>\n<h1 id=\"大文件下载\"><a class=\"anchor\" href=\"#大文件下载\">#</a> 大文件下载</h1>\n<p>大文件下载的方案则需要区分两种情况：</p>\n<p>① <code>window.open</code>  方法</p>\n<p>②分片下载</p>\n<blockquote>\n<p>其余的下载方式，例如 a 标签下载、表单下载等，都适用于较小文件，这里不讨论。</p>\n</blockquote>\n<h2 id=\"windowopen方法\"><a class=\"anchor\" href=\"#windowopen方法\">#</a>  <code>window.open</code>  方法</h2>\n<p>使用 <code>window.open</code>  方法有一个前提条件：后端接口返回的是<strong>文件流</strong>。那么用 <code>window.open</code>  去开启一个新窗口打开这个链接，浏览器就会去处理下载的过程。前端的示例代码如下：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>window<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://xxxxxxxxxx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'_blank'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>需要注意的地方是<strong>后端接口需要指定请求的 <code>Content-Disposition</code>  属性</strong>。</p>\n<blockquote>\n<p>在常规的 HTTP 应答中， <code>Content-Disposition</code>  响应头指示回复的内容该以何种形式展示，是以<strong>内联</strong>的形式（即网页或者页面的一部分），还是以<strong>附件</strong>的形式下载并保存到本地 —— 来源 MDN (<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSFRUUC9IZWFkZXJzL0NvbnRlbnQtRGlzcG9zaXRpb24=\">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition</span>)</p>\n</blockquote>\n<h3 id=\"优点\"><a class=\"anchor\" href=\"#优点\">#</a> 优点</h3>\n<ol>\n<li>浏览器自己处理下载过程，不需要额外实现进度条等逻辑。</li>\n<li>代码简单。</li>\n</ol>\n<h3 id=\"缺点\"><a class=\"anchor\" href=\"#缺点\">#</a> 缺点</h3>\n<ol>\n<li>会受到浏览器的兼容性以及浏览器安全策略等因素的影响。</li>\n<li>有时候 <code>window.open</code>  不会下载文件，而会预览文件，行为不符合预期。</li>\n<li>会新打开一个页面，有些开发者不喜欢这个行为。</li>\n</ol>\n<h2 id=\"分片下载\"><a class=\"anchor\" href=\"#分片下载\">#</a> 分片下载</h2>\n<h3 id=\"实现思路-2\"><a class=\"anchor\" href=\"#实现思路-2\">#</a> 实现思路</h3>\n<p>分片下载的逻辑类似于上文所提到的<strong>切片上传</strong>，具体的实现逻辑如下：</p>\n<ol>\n<li>获取文件的大小</li>\n<li>计算文件的分片数（即需要发送多少次下载分片的请求）</li>\n<li>下载所有分片</li>\n<li>按照顺序合并所有分片</li>\n<li>保存合并好的文件</li>\n</ol>\n<h3 id=\"前端部分-2\"><a class=\"anchor\" href=\"#前端部分-2\">#</a> 前端部分</h3>\n<p>前端代码按照实现思路来讲，可以实现为四个函数：</p>\n<ul>\n<li>获取要下载的文件大小</li>\n<li>下载文件指定位置的分片 <code>blob</code></li>\n<li>合并所有分片 <code>blob</code></li>\n<li>保存 <code>blob</code>  为文件</li>\n</ul>\n<p>在这里，我把这个流程封装为了一个开源库<a href=\"https://www.npmjs.com/package/react-chunks-to-file\"> <code>react-chunks-to-file</code> </a>，提供后端的接口地址即可完成下载操作。</p>\n<p>示例代码：</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 进度</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>percent<span class=\"token punctuation\">,</span> setPercent<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> useState<span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 状态</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">,</span> setStatus<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> useState<span class=\"token operator\">&lt;</span>number<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">return</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token operator\">&lt;</span>ChunksDownload</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    reqSetting<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span>swig￼<span class=\"token number\">0</span><span class=\"token operator\">--</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    fileName<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>csv<span class=\"token punctuation\">.</span>csv_name<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    mime<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"text/csv\"</span><span class=\"token punctuation\">&#125;</span>         <span class=\"token comment\">// 文件类型</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    size<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">3</span><span class=\"token punctuation\">&#125;</span>                  <span class=\"token comment\">// 分片大小</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    concurrency<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">5</span><span class=\"token punctuation\">&#125;</span>           <span class=\"token comment\">// 并发数</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    setStatus<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>setStatus<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    setPercent<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>setPercent<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    style<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span>swig￼<span class=\"token number\">1</span><span class=\"token operator\">--</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Button</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      type<span class=\"token operator\">=</span><span class=\"token string\">\"link\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">downloadCSV</span><span class=\"token punctuation\">(</span>csv<span class=\"token punctuation\">.</span>csv_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      下载</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Button<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ChunksDownload<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"缺点-2\"><a class=\"anchor\" href=\"#缺点-2\">#</a> 缺点</h4>\n<ol>\n<li>由于使用了 <code>blob</code> ，不同浏览器对可以下载的文件大小有限制，比如 Chrome 里是 2GB</li>\n<li>使用这个开源库，后端接口的定义需要符合要求，详情请看<a href=\"https://www.npmjs.com/package/react-chunks-to-file\"> <code>react-chunks-to-file</code> </a> 介绍</li>\n</ol>\n<h4 id=\"优点-2\"><a class=\"anchor\" href=\"#优点-2\">#</a> 优点</h4>\n<ol>\n<li>使用简单</li>\n<li>可以自己定义控制下载进度条等其他交互 UI，不会新打开窗口</li>\n<li>实现了并发下载</li>\n</ol>\n<h3 id=\"后端代码\"><a class=\"anchor\" href=\"#后端代码\">#</a> 后端代码</h3>\n<p>后端主要是提供两个接口：获取文件大小和下载文件的切片。</p>\n<blockquote>\n<p>也可以合为一个接口，文件大小从请求 header 中的 Content-Length 里获取。</p>\n</blockquote>\n<p>获取文件大小很简单，省略不讲。下面是下载文件切片的示例请求：</p>\n<p>![image-20220906205301695](/Users/nanagan/Library/Application Support/typora-user-images/image-20220906205301695.png)</p>\n<p>后端接口从 <code>Range</code>  里得知要提供文件的什么范围的切片数据。读取指定位置的文件用 Go 实现的示例代码如下：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// GetFileChunk 获取指定位置的文件片段</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">func</span> <span class=\"token function\">GetFileChunk</span><span class=\"token punctuation\">(</span>filePath <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> start<span class=\"token punctuation\">,</span> end <span class=\"token builtin\">int64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> f<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token comment\">// 跳转文件到指定位置</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Seek</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token comment\">// 读取指定长度的文件</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> byteSlice <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> end<span class=\"token operator\">-</span>start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>byteSlice<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> err</pre></td></tr><tr><td data-num=\"22\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre> <span class=\"token keyword\">return</span> byteSlice<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>但是 HTTP 请求已经默认实现了这部分，不需要再自己实现，代码仅供参考。</p>\n<h1 id=\"参考资源\"><a class=\"anchor\" href=\"#参考资源\">#</a> 参考资源</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODY0OTMxMzU=\">如何做大文件上传</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82OTU0ODY4ODc5MDM0MTU1MDIyI2hlYWRpbmctNw==\">JavaScript 中如何实现大文件并行下载？</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9xaXVmZW5nLmJsdWUvbm9kZS9maWxlLWRvd25sb2FkLmh0bWw=\">一文带你层层解锁「文件下载」的奥秘</span></p>\n",
            "tags": [
                "Frontend",
                "Frontend"
            ]
        },
        {
            "id": "http://nanakoww.com/go/%E8%AF%A6%E7%BB%86%E5%AF%B9%E6%AF%94%20Go%20%E8%AF%AD%E8%A8%80%E7%9A%84%E7%BB%98%E5%9B%BE%E5%BA%93/",
            "url": "http://nanakoww.com/go/%E8%AF%A6%E7%BB%86%E5%AF%B9%E6%AF%94%20Go%20%E8%AF%AD%E8%A8%80%E7%9A%84%E7%BB%98%E5%9B%BE%E5%BA%93/",
            "title": "【Golang】使用代码绘制图表的开源库对比",
            "date_published": "2022-08-14T12:03:55.000Z",
            "content_html": "<h1 id=\"本文的目标读者\"><a class=\"anchor\" href=\"#本文的目标读者\">#</a> 本文的目标读者</h1>\n<p>对用  <code>Golang</code>  代码生成折线图、扇形图等图表有兴趣的朋友。</p>\n<h1 id=\"本文摘要\"><a class=\"anchor\" href=\"#本文摘要\">#</a> 本文摘要</h1>\n<p>主要介绍 Go 中用以绘图的开源库，分别是：</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3djaGFyY3p1ay9nby1jaGFydA==\">GitHub - wcharczuk/go-chart: go chart is a basic charting library in go.</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3ZpY2Fuc28vZ28tY2hhcnRz\">GitHub - vicanso/go-charts: A charts library for Golang</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Zkb2JsZXIvY2hhcnQ=\">GitHub - vdobler/chart: Provide basic charts in go</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvbnVtL3Bsb3Q=\">GitHub - gonum/plot: A repository for plotting and visualizing data</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvLWVjaGFydHMvZ28tZWNoYXJ0cw==\">GitHub - go-echarts/go-echarts: 🎨 The adorable charts library for Golang</span></li>\n</ul>\n<p>我的需求是<strong>生成一个时间轴类型折线图的图片</strong>插入到我的报告中，前面两个库与我的需求比较符合，所以我会着重介绍；后面三个库不满足我的需求，在本文会大略带过。如果懒得看正文，这是我总结的表格：</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>go-chart</th>\n<th>go-charts</th>\n<th>chart</th>\n<th>plot</th>\n<th>go-echarts</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>使用文档 / 示例完善</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>学习成本</td>\n<td>中</td>\n<td>低</td>\n<td>高</td>\n<td>低</td>\n<td>低</td>\n</tr>\n<tr>\n<td>支持的图表种类</td>\n<td>少</td>\n<td>少</td>\n<td>少</td>\n<td>中</td>\n<td>多</td>\n</tr>\n<tr>\n<td>支持时间轴</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>支持输出图片</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td>支持设置标签</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>支持折线图</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td>支持自定义图表</td>\n<td>❌</td>\n<td>❌</td>\n<td>❌</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td>UI 美观</td>\n<td>⭐️⭐️⭐️</td>\n<td>⭐️⭐️⭐️⭐️</td>\n<td>⭐️⭐️</td>\n<td>⭐️⭐️</td>\n<td>⭐️⭐️⭐️⭐️⭐️</td>\n</tr>\n</tbody>\n</table>\n<p>还有一些库，例如<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZvZ2xlbWFuL2dn\"> gg</span> 和  <code>Go</code>  内部自带的  <code>image/draw</code>  包，在这里就不介绍了，因为它们俩都属于是绘制基础图形（圆形、正方形和矩形等）或者是对图像本身进行旋转、缩放、添加文字等处理的，与本文所讨论的绘制<strong>图表</strong>不太一样。</p>\n<h1 id=\"go-chart\"><a class=\"anchor\" href=\"#go-chart\">#</a> go-chart</h1>\n<p><code>go-chart</code>  是一个简单的  <code>Golang</code>  原生图表库，支持时间序列和连续折线图。因此， <code>go-chart</code>  其实对数据量特别多的情况无法很好地适应，以及如果要在图表中使用中文时，需要额外修改字体为支持中文的字体。</p>\n<h2 id=\"官方效果图\"><a class=\"anchor\" href=\"#官方效果图\">#</a> 官方效果图</h2>\n<ol>\n<li>\n<p>曲线图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193356562-597378002.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>单轴折线图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193406795-276637054.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>双轴折线图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193415579-1220952568.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>饼状图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193425445-1225878163.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>柱状图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193434729-36086823.png\" alt=\"\" /></p>\n</li>\n</ol>\n<h2 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h2>\n<pre><code>go get -u github.com/wcharczuk/go-chart\n</code></pre>\n<h2 id=\"实际使用\"><a class=\"anchor\" href=\"#实际使用\">#</a> 实际使用</h2>\n<p>我的需求是，从  <code>influxdb</code>  查询数据，再将数据渲染为折线图，代码如下：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> 前面省略查询 influxdb 过程</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>*/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>xValue <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>yValue <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">float64</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// 处理查询到的结果数据</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> value <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> allRequest<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Series<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Values <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token keyword\">if</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  yValue <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>yValue<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  t <span class=\"token operator\">:=</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  xValue <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>xValue<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value:\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  x<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>Number<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  s<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Float64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  yValue <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>yValue<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>reflect<span class=\"token punctuation\">.</span><span class=\"token function\">TypeOf</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  t <span class=\"token operator\">:=</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  xValue <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>xValue<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// 时间轴的显示格式</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>format <span class=\"token operator\">:=</span> chart<span class=\"token punctuation\">.</span><span class=\"token function\">TimeValueFormatterWithFormat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"15:04\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>lenX <span class=\"token operator\">:=</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>xValue<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// X 轴内容 xValues 及 X 轴坐标 ticks</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">var</span> xValues <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>time<span class=\"token punctuation\">.</span>Time</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">var</span> ticks <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>chart<span class=\"token punctuation\">.</span>Tick</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> lenX<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> t<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  time<span class=\"token punctuation\">.</span>RFC3339<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  xValue<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre> x <span class=\"token operator\">:=</span> t<span class=\"token punctuation\">.</span><span class=\"token function\">Local</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre> xValues <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>xValues<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre> ticks <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>ticks<span class=\"token punctuation\">,</span> chart<span class=\"token punctuation\">.</span>Tick<span class=\"token punctuation\">&#123;</span>Value<span class=\"token punctuation\">:</span> <span class=\"token function\">getNsec</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Label<span class=\"token punctuation\">:</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">// 定义曲线</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">var</span> series <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>chart<span class=\"token punctuation\">.</span>Series</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>series <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>series<span class=\"token punctuation\">,</span> chart<span class=\"token punctuation\">.</span>TimeSeries<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre> XValues<span class=\"token punctuation\">:</span> xValues<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre> YValues<span class=\"token punctuation\">:</span> yValue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre> Style<span class=\"token punctuation\">:</span> chart<span class=\"token punctuation\">.</span>Style<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  StrokeColor<span class=\"token punctuation\">:</span> chart<span class=\"token punctuation\">.</span><span class=\"token function\">GetDefaultColor</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WithAlpha</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  FillColor<span class=\"token punctuation\">:</span>   drawing<span class=\"token punctuation\">.</span><span class=\"token function\">ColorFromHex</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"9ADFEA\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">// 设置图表的样式</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>lineChartStyle <span class=\"token operator\">:=</span> chart<span class=\"token punctuation\">.</span>Style<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre> Padding<span class=\"token punctuation\">:</span> chart<span class=\"token punctuation\">.</span>Box<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  Top<span class=\"token punctuation\">:</span>  <span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  Left<span class=\"token punctuation\">:</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  Right<span class=\"token punctuation\">:</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  Bottom<span class=\"token punctuation\">:</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>graph <span class=\"token operator\">:=</span> chart<span class=\"token punctuation\">.</span>Chart<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre> Title<span class=\"token punctuation\">:</span>      <span class=\"token string\">\"All Requests\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre> Background<span class=\"token punctuation\">:</span> lineChartStyle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre> Width<span class=\"token punctuation\">:</span>      <span class=\"token number\">1280</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre> Height<span class=\"token punctuation\">:</span>     <span class=\"token number\">500</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre> XAxis<span class=\"token punctuation\">:</span> chart<span class=\"token punctuation\">.</span>XAxis<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  Name<span class=\"token punctuation\">:</span>           <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  ValueFormatter<span class=\"token punctuation\">:</span> format<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  Ticks<span class=\"token punctuation\">:</span>          ticks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre> YAxis<span class=\"token punctuation\">:</span> chart<span class=\"token punctuation\">.</span>YAxis<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  Name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre> Series<span class=\"token punctuation\">:</span> series<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>graph<span class=\"token punctuation\">.</span>Elements <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>chart<span class=\"token punctuation\">.</span>Renderable<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre> chart<span class=\"token punctuation\">.</span><span class=\"token function\">LegendLeft</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token comment\">// 生成图片</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token keyword\">var</span> imgContent bytes<span class=\"token punctuation\">.</span>Buffer</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>err <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span><span class=\"token function\">Render</span><span class=\"token punctuation\">(</span>chart<span class=\"token punctuation\">.</span>PNG<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>imgContent<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>f<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test.png\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>imgContent<span class=\"token punctuation\">.</span><span class=\"token function\">Bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这里查询了 10 分钟的数据，生成的图片为<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193451741-43936602.png\" alt=\"\" /></p>\n<p>可以看到图表上的 x 轴已经看不清了，这是因为数据点非常多，而 go-chart 没有对此进行适配。</p>\n<p>在数据点较少的情况下，比如只查询 1 分钟的数据，生成的图片为：<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193501681-1052295226.png\" alt=\"\" /></p>\n<h2 id=\"优点\"><a class=\"anchor\" href=\"#优点\">#</a> 优点</h2>\n<ul>\n<li>图表的自定义程度高，例如可以选择给曲线填充颜色等</li>\n</ul>\n<h2 id=\"缺点\"><a class=\"anchor\" href=\"#缺点\">#</a> 缺点</h2>\n<ul>\n<li>使用比较复杂<br />\n我想画的图表的 x 轴是时间轴类型，在这个库中绘制时间轴类型的 x 轴需要额外把数据进行处理为  <code>Time.time</code>  类型。如使用  <code>float64</code>  类型的 x 轴的代码会比较简单，示例如下：</li>\n</ul>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>graph <span class=\"token operator\">:=</span> chart<span class=\"token punctuation\">.</span>Chart<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Series<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>chart<span class=\"token punctuation\">.</span>Series<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        chart<span class=\"token punctuation\">.</span>ContinuousSeries<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            XValues<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">float64</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            YValues<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">float64</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4.0</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>buffer <span class=\"token operator\">:=</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">NewBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>err <span class=\"token operator\">:=</span> graph<span class=\"token punctuation\">.</span><span class=\"token function\">Render</span><span class=\"token punctuation\">(</span>chart<span class=\"token punctuation\">.</span>PNG<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><ul>\n<li>图表的样式不够精美<br />\n下面有 <code>go-charts</code>  的 demo 图，可以对比一下，确实是不如它好看。</li>\n</ul>\n<h1 id=\"go-charts\"><a class=\"anchor\" href=\"#go-charts\">#</a> go-charts</h1>\n<p><code>Go-charts</code>  是国内的程序员在  <code>go-chart</code>  的基础上优化了图表的生成方式，同时还优化了图表的样式。目前支持  <code>line</code> ,  <code>bar</code> ,  <code>horizontal bar</code> ,  <code>pie</code>  , <code>radar</code> ,  <code>funnel</code>  以及 <code>table</code>  类型的图表。</p>\n<h2 id=\"官方效果图-2\"><a class=\"anchor\" href=\"#官方效果图-2\">#</a> 官方效果图</h2>\n<p>主题为  <code>light</code>  与  <code>grafana</code>  。<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193602793-645438085.png\" alt=\"\" /></p>\n<h2 id=\"安装-2\"><a class=\"anchor\" href=\"#安装-2\">#</a> 安装</h2>\n<pre><code>go get -u github.com/vicanso/go-charts/v2\n</code></pre>\n<h2 id=\"实际使用-2\"><a class=\"anchor\" href=\"#实际使用-2\">#</a> 实际使用</h2>\n<p>同样是从  <code>influxdb</code>  查询数据，再处理数据生成图表，代码如下：</p>\n<figure class=\"highlight go\"><figcaption data-lang=\"go\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>xValue <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yValue <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">float64</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 处理结果</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> value <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> allRequest<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Series<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Values <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> tempY <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">float64</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> resultX <span class=\"token operator\">:=</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> xValue <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>xValue<span class=\"token punctuation\">,</span> resultX<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> number<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">.</span>Number<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> resultY<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> number<span class=\"token punctuation\">.</span><span class=\"token function\">Float64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> tempY <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>tempY<span class=\"token punctuation\">,</span> resultY<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 对 x 轴格式化 原：2022-07-29T09:24:10Z，新：09:24:10</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>formatXValue <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> x <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> xValue <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> formatTime<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>RFC3339<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre> formatX <span class=\"token operator\">:=</span> formatTime<span class=\"token punctuation\">.</span><span class=\"token function\">Local</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"15:04:05\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> formatXValue <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>formatXValue<span class=\"token punctuation\">,</span> formatX<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>f <span class=\"token operator\">:=</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">// 设置 x 轴的样式</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// 字体文件需要自行下载</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>buff<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> ioutil<span class=\"token punctuation\">.</span><span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./TencentSans-W7.ttf\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>err <span class=\"token operator\">=</span> charts<span class=\"token punctuation\">.</span><span class=\"token function\">InstallFont</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"noto\"</span><span class=\"token punctuation\">,</span> buff<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">// 渲染图表</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>p<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> charts<span class=\"token punctuation\">.</span><span class=\"token function\">LineRender</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre> yValue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre> charts<span class=\"token punctuation\">.</span><span class=\"token function\">FontFamilyOptionFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"noto\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre> charts<span class=\"token punctuation\">.</span><span class=\"token function\">TitleTextOptionFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"全部请求\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre> charts<span class=\"token punctuation\">.</span><span class=\"token function\">XAxisDataOptionFunc</span><span class=\"token punctuation\">(</span>xValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">*</span>charts<span class=\"token punctuation\">.</span>ChartOption<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  opt<span class=\"token punctuation\">.</span>XAxis<span class=\"token punctuation\">.</span>BoundaryGap <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>f</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  opt<span class=\"token punctuation\">.</span>Padding <span class=\"token operator\">=</span> charts<span class=\"token punctuation\">.</span>Box<span class=\"token punctuation\">&#123;</span>Left<span class=\"token punctuation\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> Right<span class=\"token punctuation\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> Top<span class=\"token punctuation\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> Bottom<span class=\"token punctuation\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre> charts<span class=\"token punctuation\">.</span><span class=\"token function\">ThemeOptionFunc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grafana\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre> charts<span class=\"token punctuation\">.</span><span class=\"token function\">WidthOptionFunc</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>查询 10 分钟的数据，生成的效果图为：<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193619652-65996810.png\" alt=\"\" /></p>\n<p>如果将主题换为  <code>light</code> ，效果图如下<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193630528-816124989.png\" alt=\"\" /></p>\n<p>如果只查询 1 分钟的数据，效果图如下<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193640505-604783444.png\" alt=\"\" /></p>\n<p>从上面的效果图中可以发现， <code>go-charts</code>  在数据量比较大的情况下，优化了 x 轴的展示，让数据不会挤在一起；以及样式也更好看一点。</p>\n<h2 id=\"优点-2\"><a class=\"anchor\" href=\"#优点-2\">#</a> 优点</h2>\n<ul>\n<li>样式好看<br />\n看上面的图，一目了然</li>\n<li>使用简单<br />\n从代码中也可以看出来， <code>go-charts</code>  对 x 轴和 y 轴的类型做了额外一层封装，x 轴的类型为  <code>string</code> ，y 轴的类型为  <code>[][]float64</code> ，只需要传相应类型的数据就可以直接渲染图表。<br />\n并且由于 y 轴的  <code>[]float64</code>  就表示一条曲线，所以如果要在图表中增加渲染的曲线也比在  <code>go-chart</code>  中要更简单 —— 直接给 y 轴数据 append 一个新的  <code>[]float64</code>  数据即可。</li>\n</ul>\n<h2 id=\"缺点-2\"><a class=\"anchor\" href=\"#缺点-2\">#</a> 缺点</h2>\n<ul>\n<li>\n<p>自定义的自由度没有  <code>go-chart</code>  高<br />\n例如 <code>go-charts</code>  中暂不支持用颜色填充曲线，以及不能自定义曲线的颜色等。</p>\n</li>\n<li>\n<p>当曲线超过 9 条后，曲线的颜色会开始重复<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193653545-1479842513.png\" alt=\"\" /></p>\n</li>\n</ul>\n<p>作者的回复是他自己的使用场景只需要用到 5 条曲线左右，建议如果涉及到太多的曲线，最好分开画图。</p>\n<p>不过都不是什么大问题，是一个很好用的开源库。</p>\n<h1 id=\"chart\"><a class=\"anchor\" href=\"#chart\">#</a> chart</h1>\n<p>前面这三个库的名字真是太像了，并且这三个库都提供基础图表的绘制功能。但是这个库更关注自动缩放、误差线和对数图等图表，并且对漂亮 UI 完全不在乎。</p>\n<h2 id=\"官方效果图-3\"><a class=\"anchor\" href=\"#官方效果图-3\">#</a> 官方效果图</h2>\n<p><img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193717347-1744707073.png\" alt=\"\" /></p>\n<h2 id=\"安装-3\"><a class=\"anchor\" href=\"#安装-3\">#</a> 安装</h2>\n<pre><code>go get -u github.com/vdobler/chart \n</code></pre>\n<h2 id=\"详细说明\"><a class=\"anchor\" href=\"#详细说明\">#</a> 详细说明</h2>\n<p>这个库支持的图表类型有</p>\n<ul>\n<li>带状图</li>\n<li>散点图 / 函数图</li>\n<li>直方图</li>\n<li>条形图和分类条形图</li>\n<li>扇形图 / 环形图</li>\n<li>箱形图</li>\n</ul>\n<p>由上所述，这个介绍为 <code>“Provide basic charts“</code> 的开源库并不支持我需要的折线图……</p>\n<p>以及在介绍里面，这个库有以下几个特点：</p>\n<ul>\n<li>轴的值可以是线性、对数、分类或者时间 / 日期轴。</li>\n<li>自动缩放具有很多选项。</li>\n<li>抽动和标签的精细控制。</li>\n</ul>\n<p>输出格式有 <code>txtg</code> 、 <code>svgg</code>  和 <code>imgg</code>  这三种格式</p>\n<h1 id=\"plot\"><a class=\"anchor\" href=\"#plot\">#</a> plot</h1>\n<p><code>plot</code>  的前身是 <code>code.google.com/p/plotinum</code> ，它提供了用于 Go 中构建和绘制图表的 API，主要用于将数据可视化。</p>\n<h2 id=\"官方效果图-4\"><a class=\"anchor\" href=\"#官方效果图-4\">#</a> 官方效果图</h2>\n<ul>\n<li>\n<p>默认样式<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193731943-342668596.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>更细粒度的控制<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193741121-1794747903.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>自定义刻度线<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193751754-1924291514.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>带误差的点<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193801368-333305905.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>条形图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193810921-181653419.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>函数<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193821494-992115268.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>直方图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193831497-1961535018.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>垂直箱形图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193842021-1167310499.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>水平箱形图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193852642-539714889.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>四分位图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193902397-1243682589.png\" alt=\"\" /></p>\n</li>\n<li>\n<p>气泡图<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814193911701-1303366568.png\" alt=\"\" /></p>\n</li>\n</ul>\n<h2 id=\"安装-4\"><a class=\"anchor\" href=\"#安装-4\">#</a> 安装</h2>\n<pre><code>go get gonum.org/v1/plot/...\n</code></pre>\n<h2 id=\"详细说明-2\"><a class=\"anchor\" href=\"#详细说明-2\">#</a> 详细说明</h2>\n<blockquote>\n<p><code>plot</code>  库其实包含以下四个部分：</p>\n<ol>\n<li><code>plot</code> ：提供了布局和绘图的简单接口；</li>\n<li><code>plotter</code> ：使用 plot 提供的接口实现了一组标准的绘图器，例如散点图、条形图、箱状图等。可以使用 plotter 提供的接口实现自己的绘图器；</li>\n<li><code>plotutil</code> ：为绘制常见图形提供简便的方法；</li>\n<li><code>vg</code> ：封装各种后端，并提供了一个通用矢量图形 API。<br />\n引自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdHVkeWdvbGFuZy5jb20vYXJ0aWNsZXMvMjgwMzY=\">《Go 每日一库之 plot》</span></li>\n</ol>\n</blockquote>\n<p>由上所述，我在使用 plot 库时，发现里面自带的基本 API 不能满足我的需求 —— 我需要一个时间轴作为 x 轴，但是 <code>plot</code>  库默认的 API 中 x 轴只支持 <code>float64</code>  类型的数据。</p>\n<p>但是在 <code>plotter</code>  中，你可以自定义一个绘图器实现一些特殊的需求，以及你还可以使用社区制作的绘图器，可以在这个网页中查看其中一部分社区绘图器：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvbnVtL3Bsb3Qvd2lraS9Db21tdW5pdHktUGxvdHRlcnM=\">Community Plotters · gonum/plot Wiki · GitHub</span>。</p>\n<p><strong>一些社区绘图器的示例图：</strong></p>\n<ol>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Jlbm9pdG1hc3Nvbi9wbG90dGVycy90cmVlL21hc3Rlci9waWVjaGFydA==\">plotters/piechart at master · benoitmasson/plotters · GitHub</span><br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814194033221-957257519.png\" alt=\"\" /></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3BwbGNjL3Bsb3RleHQ=\">GitHub - pplcc/plotext: Extensions and custom plotters for the gonum plot packages</span><br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814194043121-278430083.png\" alt=\"\" /></p>\n</li>\n</ol>\n<h1 id=\"go-echarts\"><a class=\"anchor\" href=\"#go-echarts\">#</a> go-echarts</h1>\n<p><code>go-echarts</code>  是一个专注数据可视化的图表库，参考了 <code>pyecharts</code>  的一些设计思想；目前有 v1 和 v2 两个版本，其中 v1 已经不再维护。</p>\n<h2 id=\"官方效果图-5\"><a class=\"anchor\" href=\"#官方效果图-5\">#</a> 官方效果图</h2>\n<p><img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814194055044-959523665.png\" alt=\"\" /><br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814194104041-862626997.png\" alt=\"\" /></p>\n<h2 id=\"安装-5\"><a class=\"anchor\" href=\"#安装-5\">#</a> 安装</h2>\n<pre><code>go get -u github.com/go-echarts/go-echarts/v2 \n</code></pre>\n<h2 id=\"详细介绍\"><a class=\"anchor\" href=\"#详细介绍\">#</a> 详细介绍</h2>\n<p><code>go-echarts</code>  是通过实现<span class=\"exturl\" data-url=\"aHR0cHM6Ly9lY2hhcnRzLmFwYWNoZS5vcmcvemgvaW5kZXguaHRtbA==\"> Apache ECharts</span> 的相关接口，来轻松生成全面又美观的图表。</p>\n<p>因此，在编写完生成图表的代码后，你还需要将图表渲染成一个 HTML 文件，或者是用一个 <code>HTTP</code>  服务器去渲染图表，如图：<br />\n<img data-src=\"https://img2022.cnblogs.com/blog/1943681/202208/1943681-20220814194117614-1028145679.png\" alt=\"\" /></p>\n<p>以及这个开源库渲染出来的图表也是这几个库里面最美观的（毕竟是用 <code>HTML</code>  代码渲染出来的）</p>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>本文介绍了 <code>Go</code>  中最主要的几个绘制图表的绘图库，其中对最为接近的两个开源库 <code>go-chart</code>  和 <code>go-charts</code>  进行了比较详细的对比，其余三个开源库 <code>chart</code> 、 <code>plot</code>  和 <code>go-echarts</code>  则是简单介绍了一下。<br />\n这些开源库各有各的特点，没有绝对的优劣，希望能在大家需要挑选开源库时给予一些参考。</p>\n",
            "tags": [
                "Golang",
                "Golang"
            ]
        }
    ]
}